function Em = ECvsclusters( Dim, FWHM, u_vals )
% EXPECTEDM calculates the expected value of the number m of connected
% components of an excursion set.
%--------------------------------------------------------------------------
% ARGUMENTS
% Dim: the dimensions of the random field
% FHWM: the smoothing
% u_vals: the vectors of thresholds that 
%--------------------------------------------------------------------------
% OUTPUT
% Em    the expected value of m: the number of connected components of an 
%       excursion set.
%--------------------------------------------------------------------------
% EXAMPLES
% 
%--------------------------------------------------------------------------
% SEE A

%Making a plot the the ECs vs the number of clusters in 2D.


Dim = [250,250];
S = prod(Dim);
D = length(Dim);
FWHM = 5;
W = FWHM/(4*log(2));
nsims = 50;

u_vals = 4:0.01:5;
n_u_vals = length(u_vals);
EC = zeros(1, n_u_vals);
Em = zeros(1, n_u_vals);
for I = 1:n_u_vals
    EC(I) = expectedm(S, D, W, u_vals(I));
    
    m = 0;
    
    for J = 1:nsims
        data = datagen(Dim, 1, 0, FWHM);
        m = numOfConComps(data, u_vals(I), D) + m;
    end
    
    Em(I) = m/nsims;
end

%%
plot(u_vals, EC,'linewidth', 2)
hold on
plot(u_vals, Em,'linewidth', 2)
legend('EC', 'Em')
